name: PR admin commands

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  admin-commands:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - name: Handle admin commands
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.comment?.body || '').trim();
            if (!['.merge', '.close'].includes(body)) {
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const actor = context.actor;

            const perm = await github.rest.repos.getCollaboratorPermissionLevel({
              owner,
              repo,
              username: actor,
            });

            if (perm.data.permission !== 'admin') {
              core.info(`User ${actor} is not admin; ignoring command.`);
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.payload.issue.number,
                body: 'Permission not granted.',
              });
              return;
            }

            const issueNumber = context.payload.issue.number;
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: issueNumber });
            const headRef = pr.data.head.ref;
            const headRepo = pr.data.head.repo?.full_name;
            const baseRepo = pr.data.base.repo?.full_name;

            const deleteBranch = async () => {
              if (headRepo && baseRepo && headRepo === baseRepo) {
                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `heads/${headRef}`,
                });
              } else {
                core.info('Head branch is from a fork; skipping deletion.');
              }
            };

            if (body === '.merge') {
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: issueNumber,
              });
              await deleteBranch();
              return;
            }

            if (body === '.close') {
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: issueNumber,
                state: 'closed',
              });
              await deleteBranch();
            }
